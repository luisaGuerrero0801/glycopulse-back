import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { EstadoGlucometria } from 'src/estado-glucometria/entities/estado-glucometria.entity';
import { RecomendacionesGlucometria } from 'src/recomendaciones-glucometria/entities/recomendaciones-glucometria.entity';
import { RecomendacionesEstado } from 'src/recomendaciones-estado/entities/recomendaciones-estado.entity';

@Injectable()
export class RecomendacionEstadoSeed {
  constructor(
    @InjectRepository(RecomendacionesEstado)
    private readonly recEstadoRepo: Repository<RecomendacionesEstado>,
    @InjectRepository(EstadoGlucometria)
    private readonly estadoRepo: Repository<EstadoGlucometria>,
    @InjectRepository(RecomendacionesGlucometria)
    private readonly recRepo: Repository<RecomendacionesGlucometria>
  ) {}

  async run() {
    const estados = await this.estadoRepo.find();
    const recomendaciones = await this.recRepo.find();

    // üîπ Asociaciones: estado.nombreEstado ‚Üí recomendaciones que le corresponden
    const asociaciones: Record<string, string[]> = {
      // üî¥ AYUNAS
      'Hipoglucemia Cr√≠tica Ayunas': [
        'Un nivel de glucosa en ayunas por debajo de 54 mg/dL indica hipoglucemia severa y peligrosa. Requiere atenci√≥n inmediata.',
        'Consume carbohidratos de absorci√≥n r√°pida como jugo o glucosa en gel.',
        'Evita totalmente la actividad f√≠sica.',
        'Bebe agua solo despu√©s de estabilizarte.',
        'Repite la medici√≥n y acude a urgencias si no mejora.',
      ],
      'Hipoglucemia Ayunas': [
        'Un valor de glucosa en ayunas entre 54 y 69 mg/dL indica hipoglucemia leve. Debe tratarse r√°pidamente.',
        'Ingiere 15 g de carbohidratos r√°pidos (ej. jugo, caramelos, glucosa) y luego desayuna completo.',
        'No realices ejercicio hasta normalizar los niveles.',
        'Agua simple tras la estabilizaci√≥n.',
        'Vuelve a medir en 15 minutos; si no mejora, busca atenci√≥n m√©dica.',
      ],
      'Bajo Ayunas': [
        'Un nivel en ayunas entre 70 y 79 mg/dL est√° cercano al l√≠mite bajo y requiere atenci√≥n preventiva.',
        'Incluye fruta o pan integral en el desayuno para estabilizar.',
        'Come algo antes de realizar actividad f√≠sica.',
        'Bebe agua al despertar para favorecer el equilibrio.',
        'Monitorea la frecuencia; consulta si se repite.',
      ],
      '√ìptimo Ayunas': [
        'Un nivel en ayunas dentro de 80‚Äì130 mg/dL refleja un buen control basal.',
        'Desayuna con prote√≠nas y carbohidratos complejos (ej. avena, huevo).',
        'Evita ejercicio intenso antes de comer; actividad ligera est√° bien.',
        'Agua al despertar y a lo largo del d√≠a.',
        'Registra y compara con d√≠as previos para detectar tendencias.',
      ],
      'Alto Ayunas': [
        'Un valor en ayunas de 131‚Äì180 mg/dL est√° por encima del rango recomendado.',
        'Reduce carbohidratos simples en la cena previa y prioriza fibra.',
        'Realiza una caminata ligera tras la cena si es seguro.',
        'Mant√©n hidrataci√≥n adecuada antes de dormir y al despertar.',
        'Vigila si es un patr√≥n recurrente y consulta al equipo de salud.',
      ],
      'Hiperglucemia Ayunas': [
        'Una glucosa en ayunas mayor a 180 mg/dL indica mal control nocturno.',
        'Evita carbohidratos simples en la cena y distribuye carbohidratos en porciones controladas.',
        'Actividad ligera tras la cena (si no hay contraindicaci√≥n).',
        'Agua antes de dormir y al despertar; evita bebidas azucaradas.',
        'Si persiste varios d√≠as, consulta al profesional que te atiende.',
      ],
      'Hiperglucemia Cr√≠tica Ayunas': [
        'Un valor mayor a 400 mg/dL en ayunas es una urgencia m√©dica.',
        'No comer hasta recibir orientaci√≥n m√©dica; evita carbohidratos.',
        'Evitar ejercicio hasta evaluaci√≥n m√©dica.',
        'Mantener hidrataci√≥n con agua si no hay contraindicaci√≥n.',
        'Acude a urgencias; puede requerir tratamiento urgente.',
      ],

      // üü† PREPRANDIAL
      'Hipoglucemia Cr√≠tica Preprandial': [
        'Un nivel por debajo de 54 mg/dL antes de comer indica riesgo grave de hipoglucemia severa.',
        'Consume carbohidratos de absorci√≥n r√°pida antes de ingerir la comida principal.',
        'Evita esfuerzo f√≠sico hasta normalizar la glucemia.',
        'Hidrataci√≥n tras la recuperaci√≥n.',
        'Si no mejora tras 15 minutos, busca atenci√≥n m√©dica inmediata.',
      ],
      'Hipoglucemia Preprandial': [
        'Un nivel de 54‚Äì69 mg/dL antes de comer es hipoglucemia leve.',
        'Ingiere 15 g de carbohidratos de acci√≥n r√°pida antes de comer.',
        'Suspende ejercicio hasta corregir niveles.',
        'Agua simple tras la estabilizaci√≥n.',
        'Mide de nuevo antes de iniciar la comida.',
      ],
      'Bajo Preprandial': [
        'Un rango de 70‚Äì79 mg/dL previo a la comida est√° en el l√≠mite bajo.',
        'Incluye fruta o cereal integral en tu comida.',
        'Ten precauci√≥n con la actividad f√≠sica previa.',
        'Agua para acompa√±ar la comida.',
        'Monitorea la frecuencia de valores bajos antes de comer.',
      ],
      '√ìptimo Preprandial': [
        'Un nivel entre 80‚Äì130 mg/dL antes de comer es adecuado.',
        'Comida equilibrada con prote√≠nas y carbohidratos complejos.',
        'Puedes realizar actividad ligera antes de la comida.',
        'Agua antes y durante la comida.',
        'Registra valores para control de evoluci√≥n.',
      ],
      'Alto Preprandial': [
        'Un valor entre 131‚Äì180 mg/dL previo a la comida est√° elevado.',
        'Disminuye alimentos con carbohidratos simples en la siguiente comida.',
        'Actividad ligera como caminata antes de comer.',
        'Hidrataci√≥n abundante antes y durante la comida.',
        'Eval√∫a si este patr√≥n es recurrente.',
      ],
      'Hiperglucemia Preprandial': [
        'Mayor a 180 mg/dL antes de la comida indica hiperglucemia significativa.',
        'Reduce carbohidratos simples y prefiere ensaladas y prote√≠na.',
        'Caminar 10‚Äì15 minutos previo a comer puede ayudar.',
        'Agua simple; evita bebidas azucaradas.',
        'Si se repite frecuentemente, consulta al especialista.',
      ],
      'Hiperglucemia Cr√≠tica Preprandial': [
        'Un valor mayor a 400 mg/dL antes de la comida es cr√≠tico.',
        'No iniciar la comida hasta recibir orientaci√≥n m√©dica.',
        'No realizar ejercicio f√≠sico.',
        'Mant√©n hidrataci√≥n con agua mientras recibes atenci√≥n.',
        'Acudir de inmediato a urgencias.',
      ],

      // üü° POSTPRANDIAL
      'Hipoglucemia Cr√≠tica Postprandial': [
        'Un nivel menor a 54 mg/dL despu√©s de comer es muy grave.',
        'Ingerir carbohidratos de absorci√≥n r√°pida aunque ya hayas comido.',
        'Evita toda actividad f√≠sica.',
        'Agua tras estabilizar niveles.',
        'Acude a urgencias si no mejora.',
      ],
      'Hipoglucemia Postprandial': [
        'Un valor entre 54‚Äì69 mg/dL tras la comida es bajo.',
        'A√±ade carbohidratos r√°pidos extra.',
        'Evita ejercicio f√≠sico tras la comida.',
        'Bebe agua al estabilizarte.',
        'Monitorea evoluci√≥n cada 15 minutos.',
      ],
      'Bajo Postprandial': [
        'Un nivel entre 70‚Äì79 mg/dL despu√©s de comer es bajo.',
        'A√±ade un peque√±o snack saludable.',
        'Precauci√≥n con actividad f√≠sica posterior.',
        'Agua para mantener equilibrio.',
        'Consulta si se repite con frecuencia.',
      ],
      '√ìptimo Postprandial': [
        'Un rango de 80‚Äì140 mg/dL despu√©s de comer es adecuado.',
        'Alimentos balanceados en siguientes comidas.',
        'Caminata ligera puede ser beneficiosa.',
        'Agua tras la comida.',
        'Registra valores para control personal.',
      ],
      'Alto Postprandial': [
        'Un nivel entre 141‚Äì199 mg/dL tras comer es elevado.',
        'Reduce porciones de carbohidratos simples en pr√≥ximas comidas.',
        'Realiza actividad ligera postcomida.',
        'Hidrataci√≥n adecuada despu√©s de comer.',
        'Vigilar tendencia; si es frecuente, ajustar plan alimenticio.',
      ],
      'Hiperglucemia Postprandial': [
        'Un valor mayor a 200 mg/dL despu√©s de comer indica hiperglucemia.',
        'Limitar carbohidratos simples; preferir vegetales y prote√≠nas.',
        'Caminata de 15 minutos tras la comida puede ayudar.',
        'Agua sin az√∫car tras la comida.',
        'Consultar con especialista si es repetitivo.',
      ],
      'Hiperglucemia Cr√≠tica Postprandial': [
        'Un nivel mayor a 400 mg/dL tras la comida es una urgencia.',
        'No ingerir m√°s comida hasta estabilizarte.',
        'Suspender toda actividad f√≠sica.',
        'Solo agua mientras recibes atenci√≥n.',
        'Acude inmediatamente a urgencias.',
      ],

      // üåô OTROS (Ayuno nocturno, antes de dormir, madrugada)
      'Hipoglucemia Cr√≠tica Otros': [
        'Un valor menor a 54 mg/dL en la madrugada o antes de dormir es muy grave.',
        'Consumir carbohidratos de absorci√≥n r√°pida.',
        'Evita dormir hasta que se normalice.',
        'Agua despu√©s de estabilizarte.',
        'Busca atenci√≥n urgente si no mejora.',
      ],
      'Hipoglucemia Otros': [
        'Un rango de 54‚Äì69 mg/dL durante la noche es bajo.',
        'Consumir carbohidratos r√°pidos como jugo o galletas.',
        'No realizar actividad f√≠sica nocturna.',
        'Agua simple tras estabilizaci√≥n.',
        'Revisar de nuevo en 15 minutos.',
      ],
      'Bajo Otros': [
        'Un nivel de 70‚Äì79 mg/dL en la madrugada es bajo.',
        'Snack ligero con carbohidratos complejos antes de dormir.',
        'Precauci√≥n si haces actividad f√≠sica nocturna.',
        'Mantener hidrataci√≥n antes de dormir.',
        'Consulta si el patr√≥n se repite.',
      ],
      '√ìptimo Otros': [
        'Un nivel entre 80‚Äì130 mg/dL en la noche es adecuado.',
        'Cena balanceada antes de dormir.',
        'Actividad ligera antes de acostarse est√° bien.',
        'Agua antes de dormir.',
        'Registrar evoluci√≥n de niveles nocturnos.',
      ],
      'Alto Otros': [
        'Un valor entre 131‚Äì180 mg/dL antes de dormir es elevado.',
        'Evita carbohidratos simples en la cena.',
        'Caminar tras la cena puede ayudar.',
        'Mant√©n hidrataci√≥n con agua.',
        'Consulta si los valores son frecuentes.',
      ],
      'Hiperglucemia Otros': [
        'Un nivel mayor a 180 mg/dL en la madrugada o al dormir indica mal control.',
        'Evita comidas nocturnas con az√∫car.',
        'Actividad ligera despu√©s de la cena puede ayudar.',
        'Agua sin az√∫car antes de dormir.',
        'Si ocurre seguido, acudir al m√©dico.',
      ],
      'Hiperglucemia Cr√≠tica Otros': [
        'Un valor mayor a 400 mg/dL en la noche es cr√≠tico.',
        'No ingerir m√°s comida.',
        'No realizar actividad f√≠sica.',
        'Mant√©n hidrataci√≥n solo con agua.',
        'Acude a urgencias de inmediato.',
      ],
    };

    for (const [nombreEstado, textos] of Object.entries(asociaciones)) {
      const estado = estados.find((e) => e.nombreEstado === nombreEstado);
      if (!estado) continue;

      for (const texto of textos) {
        const recomendacion = recomendaciones.find(
          (r) => r.descripcionRecomendacion === texto
        );
        if (!recomendacion) continue;

        const existe = await this.recEstadoRepo.findOne({
          where: {
            estado: { idEstado: estado.idEstado },
            recomendacion: { idRecomendacion: recomendacion.idRecomendacion },
          },
        });

        if (!existe) {
          await this.recEstadoRepo.save(
            this.recEstadoRepo.create({ estado, recomendacion })
          );
        }
      }
    }

    console.log('‚úÖ Asociaciones Estado ‚Üî Recomendaciones insertadas');
  }
}
